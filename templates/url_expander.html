{% extends 'base.html' %}

{% block content %}
<div class="chat-header">
    <h2>ğŸ”— ì•ˆì‹¬ ë§í¬ (URL ê²€ì‚¬ê¸°)</h2>
</div>

<div class="chat-body centered" id="chat-container">
    <div id="welcome-message" style="text-align: center; max-width: 600px;">
        <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë‹¨ì¶• URLì„ í™•ì¸í•˜ì„¸ìš”</h3>
        <p>
            ë‹¨ì¶• URLì˜ ìµœì¢… ëª©ì ì§€ì™€ URLì˜ ì—°ê²°/ì•…ì„± ì—¬ë¶€ ë“±ì„ í™•ì¸í•©ë‹ˆë‹¤.<br>
            phshing databaseë¥¼ ì´ìš©í•˜ì—¬ ì•…ì„± URLì„ ê²€ì‚¬í•©ë‹ˆë‹¤.
        </p>
    </div>
    <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
</div>

<div class="chat-footer">
    <form id="url-form" style="width: 100%; display: flex; justify-content: center;">
        <div class="input-wrapper">
            <input type="url" id="url" name="url" required placeholder="í™•ì¸í•  ë‹¨ì¶• URLì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: bit.ly/...)" autofocus
                autocomplete="off">
            <button type="submit" title="í™•ì¸í•˜ê¸°">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                </svg>
            </button>
        </div>
    </form>
</div>

<style>
    .result-box.safe {
        background-color: rgba(34, 197, 94, 0.15);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .result-box.suspicious {
        background-color: rgba(234, 179, 8, 0.15);
        border: 1px solid rgba(234, 179, 8, 0.3);
    }

    .result-box.malicious {
        background-color: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .result-box.error {
        background-color: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .badge {
        padding: 4px 12px;
        border-radius: 4px;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .badge.safe {
        background: rgba(34, 197, 94, 0.2);
        color: #4ade80;
    }

    .badge.suspicious {
        background: rgba(234, 179, 8, 0.2);
        color: #facc15;
    }

    .badge.malicious {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
    }

    .badge.unknown {
        background: rgba(148, 163, 184, 0.2);
        color: #cbd5e1;
    }

    .report-grid {
        display: grid;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .report-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
    }

    .report-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .report-value {
        font-weight: 600;
        color: var(--text-primary);
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    document.getElementById('url-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const urlInput = document.getElementById('url');
        const url = urlInput.value;
        if (!url) return;

        // ì…ë ¥ ì´ˆê¸°í™”
        urlInput.value = '';

        // í™˜ì˜ ë©”ì‹œì§€ ìˆ¨ê¹€
        const welcomeMsg = document.getElementById('welcome-message');
        if (welcomeMsg) {
            welcomeMsg.style.display = 'none';
            document.getElementById('chat-container').classList.remove('centered');
        }

        // ë¡œë”© í‘œì‹œê¸° ì¶”ê°€
        const loadingId = 'loading-' + Date.now();
        appendLoading(loadingId, url);

        try {
            const response = await fetch('/api/url-expander', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            });

            // ë¡œë”© ì•ˆì „í•˜ê²Œ ì œê±°
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) loadingEl.remove();

            let data;
            try {
                data = await response.json();
            } catch (e) {
                throw new Error('ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            // data.errorê°€ ìˆì§€ë§Œ safety_statusë„ ìˆëŠ” ê²½ìš°, ê²°ê³¼ ë°•ìŠ¤(ì˜¤ë¥˜ í¬í•¨)ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
            // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ë°•ìŠ¤ ëŒ€ì‹ .
            if (data.error && data.safety_status) {
                appendResult(data);
            } else if (!response.ok) {
                appendError(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', data.input_url || url);
            } else {
                appendResult(data);
            }

        } catch (error) {
            console.error('Error:', error);
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) loadingEl.remove();
            appendError(error.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', url);
        }
    });

    function appendLoading(id, url) {
        const container = document.getElementById('chat-container');
        const html = `
        <div id="${id}" class="result-box" style="opacity: 0.7;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="loading-spinner"></div>
                <div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">ë¶„ì„ ì¤‘...</div>
                    <div style="font-weight: 600;">${url}</div>
                </div>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
        container.scrollTop = container.scrollHeight;
    }

    function appendError(msg, url) {
        const container = document.getElementById('chat-container');
        const html = `
        <div class="result-box error" style="animation: fadeIn 0.3s ease-out;">
            <div style="margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                ì…ë ¥ URL: ${url}
            </div>
            <div style="color: #f87171; font-weight: 600;">
                âš ï¸ ${msg}
            </div>
            <div style="margin-top: 4px; font-size: 0.85rem; color: #fca5a5;">
                â€» ìœ„í—˜í•œ ì›¹ì‚¬ì´íŠ¸ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”.
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
        container.scrollTop = container.scrollHeight;
    }

    function appendResult(data) {
        const container = document.getElementById('chat-container');

        let statusClass = 'safe';
        // statusTextëŠ” ì´ì œ ë°±ì—”ë“œì—ì„œ í•œêµ­ì–´ë¡œ ì œê³µë˜ì§€ë§Œ, í´ë˜ìŠ¤ì— ë§¤í•‘í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
        // ë°±ì—”ë“œ ë°˜í™˜ê°’: "ì•ˆì „í•¨", "ì˜ì‹¬ë¨...", "ìœ„í—˜..."

        if (data.safety_status.includes('ì˜ì‹¬ë¨')) {
            statusClass = 'suspicious';
        } else if (data.safety_status.includes('ìœ„í—˜')) {
            statusClass = 'malicious';
        }

        let errorHtml = '';
        if (data.error) {
            errorHtml = `
            <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.2); border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.3);">
                <div style="color: #fca5a5; font-size: 0.9rem; font-weight: 600; margin-bottom: 4px;">âš ï¸ ì—°ê²° ì˜¤ë¥˜</div>
                <div style="color: #fff; font-size: 0.9rem;">${data.error}</div>
                <div style="margin-top: 4px; font-size: 0.85rem; color: #fca5a5;">
                    â€» ìœ„í—˜í•œ ì›¹ì‚¬ì´íŠ¸ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”.
                </div>
            </div>`;
        }

        const html = `
        <div class="result-box ${statusClass}" style="animation: fadeIn 0.3s ease-out;">
            <div style="margin-bottom: 1rem;">
                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 4px;">ì…ë ¥ URL</div>
                <div style="font-family: monospace; word-break: break-all;">${data.input_url}</div>
            </div>
            
            ${errorHtml}

            <div style="margin-bottom: 1.5rem;">
                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 4px;">ìµœì¢… ëª©ì ì§€</div>
                <div style="font-size: 1.1rem; font-weight: 600; color: var(--accent-color); word-break: break-all;">
                    <a href="${data.final_url}" target="_blank" style="color: inherit; text-decoration: underline;">${data.final_url}</a>
                </div>
            </div>

            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <span class="badge ${statusClass}">${data.safety_status}</span>
                <span style="font-size: 0.9rem; color: var(--text-secondary);">
                    HTTP ìƒíƒœ: <span style="color: #fff;">${data.status_code || 'N/A'}</span>
                </span>
            </div>
        </div>
        `;

        container.insertAdjacentHTML('beforeend', html);
        container.scrollTop = container.scrollHeight;
    }
</script>
{% endblock %}