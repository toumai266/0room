{% extends 'base.html' %}

{% block content %}
<div class="chat-header">
    <h2>ğŸ” ì•”í˜¸ ë³´ì•ˆ ìˆ˜ì¤€ ê²€ì‚¬ê¸°</h2>
</div>

<div class="chat-body centered" id="chat-container">
    <div id="welcome-message" style="text-align: center; max-width: 600px;">
        <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">ë¹„ë°€ë²ˆí˜¸ ë³´ì•ˆì„±ì„ í™•ì¸í•´ë³´ì„¸ìš”</h3>
        <p>
            ì—”íŠ¸ë¡œí”¼ ë¶„ì„ ë° íŒ¨í„´ ë§¤ì¹­ì„ í†µí•´ ì‹¤ì œ í•´í‚¹ ì†Œìš” ì‹œê°„ì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤.<br>
            ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ëŠ” ì„œë²„ì— ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
    </div>
    <!-- Chat history will be appended here -->
</div>

<div class="chat-footer">
    <form id="password-form" style="width: 100%; display: flex; justify-content: center;">
        <div class="input-wrapper">
            <input type="password" id="password" name="password" required placeholder="ê²€ì‚¬í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...(ìµœëŒ€ 30ì)"
                autofocus autocomplete="off" maxlength="30">
            <button type="submit" title="ê²€ì‚¬í•˜ê¸°">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                </svg>
            </button>
        </div>
    </form>
</div>

<style>
    /* Dynamic Result Box Colors */
    .result-box.weak {
        background-color: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .result-box.medium {
        background-color: rgba(234, 179, 8, 0.15);
        border: 1px solid rgba(234, 179, 8, 0.3);
    }

    .result-box.strong {
        background-color: rgba(34, 197, 94, 0.15);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .badge {
        padding: 4px 12px;
        border-radius: 4px;
    }

    .report-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }

    .report-label {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .report-msg {
        font-size: 0.9rem;
    }

    .report-icon {
        font-size: 1.2rem;
        line-height: 1;
    }

    /* Checked Password Display */
    .checked-password-display {
        font-family: monospace;
        background: rgba(0, 0, 0, 0.3);
        padding: 8px 12px;
        border-radius: 6px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .timestamp {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-left: 1rem;
    }
</style>

<script>
    document.getElementById('password-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const passwordInput = document.getElementById('password');
        const password = passwordInput.value;
        if (!password) return;

        // Clear input
        passwordInput.value = '';

        // Hide welcome message if it's the first check
        const welcomeMsg = document.getElementById('welcome-message');
        if (welcomeMsg) {
            welcomeMsg.style.display = 'none';
            document.getElementById('chat-container').classList.remove('centered');
        }

        try {
            const response = await fetch('/api/password-check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ password: password })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Network response was not ok');
            }

            const data = await response.json();
            appendResult(data);

            // Scroll to bottom
            const chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;

        } catch (error) {
            console.error('Error:', error);
            alert(error.message || 'ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });

    function appendResult(data) {
        const container = document.getElementById('chat-container');

        let suggestionsHtml = '';
        if (data.feedback.suggestions && data.feedback.suggestions.length > 0) {
            suggestionsHtml = `
            <div class="report-item info">
                <div class="report-icon">ğŸ’¡</div>
                <div class="report-content">
                    <div class="report-label">ê°œì„  ì œì•ˆ</div>
                    <ul style="margin-top: 0.25rem; padding-left: 1.2rem; font-size: 0.9rem;">
                        ${data.feedback.suggestions.map(s => `<li style="margin-bottom: 4px;">${s}</li>`).join('')}
                    </ul>
                </div>
            </div>`;
        }

        let warningHtml = '';
        if (data.feedback.warning) {
            warningHtml = `
            <div class="report-item fail">
                <div class="report-icon">âš ï¸</div>
                <div class="report-content">
                    <div class="report-label">ê²½ê³ </div>
                    <div class="report-msg">${data.feedback.warning}</div>
                </div>
            </div>`;
        }

        let passHtml = '';
        if (!data.feedback.warning && (!data.feedback.suggestions || data.feedback.suggestions.length === 0)) {
            passHtml = `
            <div class="report-item pass">
                <div class="report-icon">âœ…</div>
                <div class="report-content">
                    <div class="report-label">ì™„ë²½í•©ë‹ˆë‹¤!</div>
                    <div class="report-msg">íŠ¹ë³„í•œ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>`;
        }

        const html = `
        <div class="result-box ${data.css_class}" style="transition: background-color 0.3s ease; animation: fadeIn 0.3s ease-out;">
            <div class="checked-password-display">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸:</span>
                <span style="color: var(--text-primary); font-weight: 600;">${data.password}</span>
            </div>

            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 1.5rem;">
                <span style="font-size: 1.1rem; font-weight: 600; color: #fff;">ë³´ì•ˆ ê°•ë„</span>
                <span class="badge" style="font-size: 1.2rem; font-weight: 700; background: rgba(0,0,0,0.2); color: #fff;">${data.strength}</span>
            </div>

            <div class="report-grid" style="display: grid; gap: 1rem;">
                <div class="report-item info">
                    <div class="report-icon">â±ï¸</div>
                    <div class="report-content">
                        <div class="report-label">
                            ì˜ˆìƒ í•´í‚¹ ì†Œìš” ì‹œê°„
                        </div>
                        <div class="report-msg" style="font-size: 1rem; font-weight: 600;">${data.crack_time}</div>
                        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 4px;">ê³µê²©ìê°€ ì´ˆë‹¹ 10,000ë²ˆì˜ ì¶”ì¸¡ì„ ì‹œë„í•˜ëŠ” ì˜¤í”„ë¼ì¸ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ ê¸°ì¤€ì…ë‹ˆë‹¤.</div>
                    </div>
                </div>
                ${warningHtml}
                ${suggestionsHtml}
                ${passHtml}
            </div>
        </div>
        `;

        container.insertAdjacentHTML('beforeend', html);
    }
</script>
<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}